<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Firmenlauf 2026</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
form { max-width: 600px; margin-bottom: 20px; }
input, select, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
button { cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; }
button:hover { background: #45a049; }
label { font-weight: bold; display: block; margin-top: 10px; }
small { display: block; font-weight: normal; color: #555; margin-bottom: 5px; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background: #f0f0f0; }
.error { color: red; margin-top: 10px; }
@media (max-width: 500px) {
  body { margin: 10px; }
  input, select, button { font-size: 16px; }
  table { font-size: 14px; }
}
#downloadBtn { margin-top:10px; display:none; }
.person-group { margin-bottom: 15px; }
</style>
</head>
<body>

<h2>üèÉ Firmenlauf Anmeldung</h2>

<form id="surveyForm">
    <div class="person-group">
        <label>Person 1</label>
        <input id="p1" placeholder="Name" required>
        <select id="tshirt1">
            <option value="Nein">T-Shirt: Nein</option>
            <option value="Ja">T-Shirt: Ja</option>
        </select>
        <select id="size1">
            <option value="">Gr√∂√üe</option>
            <optgroup label="Frauen">
                <option value="Frauen S">S</option>
                <option value="Frauen M">M</option>
                <option value="Frauen L">L</option>
                <option value="Frauen XL">XL</option>
                <option value="Frauen 2XL">2XL</option>
            </optgroup>
            <optgroup label="M√§nner">
                <option value="M√§nner S">S</option>
                <option value="M√§nner M">M</option>
                <option value="M√§nner L">L</option>
                <option value="M√§nner XL">XL</option>
                <option value="M√§nner 2XL">2XL</option>
            </optgroup>
        </select>
    </div>

    <div class="person-group">
        <label>Person 2</label>
        <input id="p2" placeholder="Name">
        <select id="tshirt2">
            <option value="Nein">T-Shirt: Nein</option>
            <option value="Ja">T-Shirt: Ja</option>
        </select>
        <select id="size2">
            <option value="">Gr√∂√üe</option>
            <optgroup label="Frauen">
                <option value="Frauen S">S</option>
                <option value="Frauen M">M</option>
                <option value="Frauen L">L</option>
                <option value="Frauen XL">XL</option>
                <option value="Frauen 2XL">2XL</option>
            </optgroup>
            <optgroup label="M√§nner">
                <option value="M√§nner S">S</option>
                <option value="M√§nner M">M</option>
                <option value="M√§nner L">L</option>
                <option value="M√§nner XL">XL</option>
                <option value="M√§nner 2XL">2XL</option>
            </optgroup>
        </select>
    </div>

    <div class="person-group">
        <label>Person 3</label>
        <input id="p3" placeholder="Name">
        <select id="tshirt3">
            <option value="Nein">T-Shirt: Nein</option>
            <option value="Ja">T-Shirt: Ja</option>
        </select>
        <select id="size3">
            <option value="">Gr√∂√üe</option>
            <optgroup label="Frauen">
                <option value="Frauen S">S</option>
                <option value="Frauen M">M</option>
                <option value="Frauen L">L</option>
                <option value="Frauen XL">XL</option>
                <option value="Frauen 2XL">2XL</option>
            </optgroup>
            <optgroup label="M√§nner">
                <option value="M√§nner S">S</option>
                <option value="M√§nner M">M</option>
                <option value="M√§nner L">L</option>
                <option value="M√§nner XL">XL</option>
                <option value="M√§nner 2XL">2XL</option>
            </optgroup>
        </select>
    </div>

    <label>Team</label>
    <input id="team" value="Zufall">
    <small>Team eintragen. Bei "Zufall" wird der Benutzer einem Team zugeordnet, bzw. bei vollen Teams ein neues Team mit Zufallsnamen erstellt.</small>
    
    <button type="submit">Absenden</button>
</form>

<button id="downloadBtn">üì• Teams als Excel herunterladen</button>

<div id="error" class="error"></div>

<h2>üìã Teams</h2>
<table>
<thead>
<tr>
<th>Team</th>
<th>Teilnehmer</th>
<th>T-Shirt</th>
<th>Gr√∂√üe</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, doc, getDocs, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app-check.js";

const firebaseConfig = {
  apiKey: "DEIN_FIREBASE_KEY",
  authDomain: "firmenlauf-8e694.firebaseapp.com",
  projectId: "firmenlauf-8e694",
  storageBucket: "firmenlauf-8e694.firebasestorage.app",
  messagingSenderId: "740730808511",
  appId: "1:740730808511:web:11a5d055eb10790a453e0a",
  measurementId: "G-N1BFHE44SJ"
};

const app = initializeApp(firebaseConfig);

initializeAppCheck(app, {
  provider: new ReCaptchaV3Provider("DEIN_RECAPTCHA_KEY"),
  isTokenAutoRefreshEnabled: true
});

const db = getFirestore(app);
const teamsRef = collection(db, "teams");

const error = document.getElementById("error");
const downloadBtn = document.getElementById("downloadBtn");

const nameA = ["Byte","CPU","RAM","Pixel","Code","Server","GPU","Kernel","Disk","Cache"];
const nameB = ["Runner","Sprint","Dash","Speed","Marathon","Track","Stride","Loop","Flow","Turbo"];
function randomTeamName() {
    const partA = nameA[Math.floor(Math.random()*nameA.length)];
    const partB = nameB[Math.floor(Math.random()*nameB.length)];
    const num = Math.floor(Math.random()*1000);
    return `${partA} ${partB} ${num}`;
}

async function getAllTeams() {
    const snap = await getDocs(teamsRef);
    const teams = {};
    snap.forEach(d => teams[d.id] = d.data().members);
    return teams;
}

function nameExists(name, teams) {
    return Object.values(teams).some(members =>
        members.some(m => m.name.toLowerCase() === name.toLowerCase())
    );
}

async function findOrCreateFreeTeam(teams) {
    for (const t in teams) {
        if (teams[t].length < 3) return t;
    }
    let name;
    do { name = randomTeamName(); } while (teams[name]);
    await setDoc(doc(db, "teams", name), { members: [] });
    return name;
}

/* Klick-Z√§hler f√ºr versteckten Download */
let clickCount = 0;
const teamInput = document.getElementById("team");
teamInput.addEventListener("click", () => {
    clickCount++;
    if (clickCount >= 5) downloadBtn.style.display = "block";
});

/* Formular-Submit */
surveyForm.addEventListener("submit", async e => {
    e.preventDefault();
    error.textContent = "";

    const persons = [
        {name: p1.value.trim(), tshirt: document.getElementById("tshirt1").value, size: document.getElementById("size1").value},
        {name: p2.value.trim(), tshirt: document.getElementById("tshirt2").value, size: document.getElementById("size2").value},
        {name: p3.value.trim(), tshirt: document.getElementById("tshirt3").value, size: document.getElementById("size3").value}
    ].filter(p => p.name);

    if (persons.length === 0) return;

    let teams = await getAllTeams();

    for (const person of persons) {
        if (nameExists(person.name, teams)) {
            error.textContent = `‚ùå "${person.name}" ist bereits in einem Team eingetragen.`;
            return;
        }
    }

    let teamNameInput = teamInput.value.trim();
    let teamName = "";

    if (persons.length > 1) {
        if (!teamNameInput || teamNameInput.toLowerCase() === "zufall") {
            let name;
            do { name = randomTeamName(); } while (teams[name]);
            await setDoc(doc(db, "teams", name), { members: [] });
            teamName = name;
        } else {
            if (teams[teamNameInput]) {
                error.textContent = `‚ùå Teamname "${teamNameInput}" existiert bereits. Bitte anderen Namen w√§hlen.`;
                return;
            }
            await setDoc(doc(db, "teams", teamNameInput), { members: [] });
            teamName = teamNameInput;
        }
    } else {
        if (!teamNameInput || teamNameInput.toLowerCase() === "zufall") {
            teamName = await findOrCreateFreeTeam(teams);
        } else if (teams[teamNameInput] && teams[teamNameInput].length >= 3) {
            const ok = confirm(`Das Team "${teamNameInput}" ist voll. Willst du einem freien Team per Zufall zugeteilt werden?`);
            if (!ok) return;
            teamName = await findOrCreateFreeTeam(teams);
        } else {
            teamName = teamNameInput;
        }
    }

    let members = teams[teamName] || [];
    for (const person of persons) {
        if (members.length >= 3) {
            teams = await getAllTeams();
            teamName = await findOrCreateFreeTeam(teams);
            members = [];
        }
        members.push(person);
    }

    await setDoc(doc(db, "teams", teamName), { members }, { merge: true });

    surveyForm.reset();
    teamInput.value = "Zufall";
});

/* Live Tabelle */
onSnapshot(teamsRef, snap => {
    tableBody.innerHTML = "";
    snap.forEach(d => {
        const tr = document.createElement("tr");
        d.data().members.forEach(m => {
            const tdName = document.createElement("td");
            tdName.textContent = m.name;
            const tdTshirt = document.createElement("td");
            tdTshirt.textContent = m.tshirt;
            const tdSize = document.createElement("td");
            tdSize.textContent = m.size;
            const tdTeam = document.createElement("td");
            tdTeam.textContent = d.id;
            const row = document.createElement("tr");
            row.appendChild(tdTeam);
            row.appendChild(tdName);
            row.appendChild(tdTshirt);
            row.appendChild(tdSize);
            tableBody.appendChild(row);
        });
    });
});

/* CSV Download */
downloadBtn.addEventListener("click", async () => {
    const teams = await getAllTeams();
    let csv = "Team,Name,T-Shirt,Gr√∂√üe\n";
    for (const t in teams) {
        teams[t].forEach(m => {
            csv += `"${t}","${m.name}","${m.tshirt}","${m.size}"\n`;
        });
    }
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `firmenlauf_teams.csv`;
    a.click();
    URL.revokeObjectURL(url);
});
</script>

</body>
</html>
